# マイクロサービスのためのサービスメッシュ "Istio" を本番環境で利用するには？

* [マイクロサービスのためのサービスメッシュ "Istio" を本番環境で利用するには？](https://cloud.withgoogle.com/next18/tokyo/my-schedule/session/223397)

## モノリス

* 1つの言語
* 複雑化
* 巨大化するとコードメンテナンスが大変
* テストも大変
* デプロイも大変
  * バラバラにデプロイできない
  * 一番遅いところに合わせてロールアウト

## マイクロサービス

* モノリスをマイクロサービスに分解
* 開発スピードも上がった
* テストも簡単
* デプロイも簡単
* 成功！

## マイクロサービスの欠点

* ネットワークを経由してAPIがコールされるので信頼性が失われた
  * レイテンシも大きくなった
* セキュリティも考慮しなければいけない
  * 誰でも API がコールできてはいけない

## 修復するには

* コールのリトライ
* トレーシングの追加
* セキュリティライブラリや認証機構を入れる
* インフラのレイヤーの処理をプログラムで書かなければいけない

## ネットワークにインテリジェンスを取り込む

* サービスメッシュ
  * サービスのためのネットワーク
  * パケットベースでどこに送るか
  * アプリケーションのトラフィックを認識する

## サービスメッシュ

* トラフィックコントロール
* 可観測性
* セキュリティ
* 全てが k8s の環境で実行されるわけではない

## サイドカー

* 二つのコンテナをおなじ pod にデプロイ
* トラフィックコントロール

## Envoy

* L4/L7プロキシベース(C++)
* ローメモリのフットプリント
* Lyftでの実績
* HTTP/2, gRPC

## Istio

### トラフィックコントロール

全体の 10% だけデプロイした新サービスにアクセスさせたい

* Istio 以前
  * インフラストラクチャに結びつけられたトラフィックコントロール
  * 9/10 の旧サービスをデプロイする
    * 1/10 新サービスにアクセスが行く
* Istio 以後
  * インフラストラクチャから分離されたトラフィックフローs

### 可観測性

* 全てのネットワークトラフィックを可視化できる

### セキュリティ

* 通常のコミュニケーション
  * [front] -> [payment]
* Istio
  * [front/proxy] -> [citadel] -> [payment/proxy]
  * 認証された時のみ通信可能みたいなのができる

## 導入事例

* 1.0 ができたのは 2ヶ月前
* Descartes Labs
  * トラフィックの図式化のためだけに Istio を入れた
  * どこのサービスがボトルネックとかわかるようになった
  * こういうケースにも使える

## Istio アラカルト

* 複数の Istio の機能を全て使う必要はない
* 必要なものだけ使う
  * 段階的に採用することができる
* 小さく始めよう
